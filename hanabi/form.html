<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>花火大会新規登録</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Custom Script -->
  <script type="module" src="../assets/js/hanabi/form.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanilla-autokana/dist/autokana.min.js" defer></script>
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
  <!-- Styles -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/sanitize.css">
  <link rel="stylesheet" href="../assets/css/common/layout.css">
  <link rel="stylesheet" href="../assets/css/hanabi/form.css">
</head>

<body x-data="App">
  <header class="header">
    <div class="header-inner">
      <h1 class="header-title"><a href="../index.html">着付予約管理システム</a></h1>
      <div class="header-controls">
        <select x-model.number="selectedYear">
          <template x-for="year in yearOptions" :key="year">
            <option :value="year" x-text="year" :selected="year === selectedYear"></option>
          </template>
        </select>
        <span>花火大会</span>
      </div>
      <nav class="header-nav">
        <a :href="`./statistics.html?year=${selectedYear}`">統計情報</a>
        <a :href="`./index.html?year=${selectedYear}`">予約一覧</a>
        <a :href="`./image-list.html?year=${selectedYear}`">画像一覧</a>
        <a :href="`./form.html?year=${selectedYear}`">新規登録</a>
      </nav>
    </div>
  </header>
  <div class="cancellation-status" x-show="representative.isCanceled === true" x-cloak>この予約はすでにキャンセルされています</div>
  <div class="delete-container">
    <button type="button" class="delete-btn" x-show="currentGroupId" @click="deleteForm">
      <i class="fa-regular fa-trash-can"></i> カルテを削除
    </button>
  </div>
  <form @submit.prevent="submitForm">
    <main>
      <div class="form-section">
        <h2 class="section-title" @click="isRepresentativeInfoOpen = !isRepresentativeInfoOpen">
          代表者情報
          <i class="fa-solid" :class="isRepresentativeInfoOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        </h2>
        <div x-show="isRepresentativeInfoOpen">
          <table class="form-table">
            <tr>
              <th>予約方法</th>
              <td>
                <label><input type="radio" name="reservationMethod" value="じゃらん椿"
                    @click="toggleRadio($event, 'reservationMethod')"
                    :checked="representative.reservationMethod === 'じゃらん椿'"> じゃらん椿</label>
                <label><input type="radio" name="reservationMethod" value="じゃらん教室"
                    @click="toggleRadio($event, 'reservationMethod')"
                    :checked="representative.reservationMethod === 'じゃらん教室'"> じゃらん教室</label>
                <label><input type="radio" name="reservationMethod" value="アソビュー"
                    @click="toggleRadio($event, 'reservationMethod')"
                    :checked="representative.reservationMethod === 'アソビュー'"> アソビュー</label>
              </td>
            </tr>
            <tr>
              <th>代表者名</th>
              <td><input type="text" x-model="representative.name" id="name" required class="middle-width"></td>
            </tr>
            <tr>
              <th>ふりがな</th>
              <td><input type="text" x-model="representative.kana" id="furigana" class="middle-width"></td>
            </tr>
            <tr>
              <th>来店時間</th>
              <td><input type="time" x-model="representative.visitTime" class="middle-width"></td>
            </tr>
            <tr>
              <th>人数</th>
              <td class="person-count">
                女 <input type="number" min="0" x-model.number="femaleCount">
                男 <input type="number" min="0" x-model.number="maleCount">
              </td>
            </tr>
            <tr>
              <th>住所</th>
              <td><input type="text" class="full-width" x-model="representative.address"></td>
            </tr>
            <tr>
              <th>電話番号</th>
              <td><input type="tel" x-model="representative.phone" placeholder="080123456" inputmode="numeric"
                  pattern="[0-9]*" class="middle-width"></td>
            </tr>
            <tr>
              <th>交通手段</th>
              <td>
                <label><input type="radio" name="transportation" value="car"
                    @click="toggleRadio($event, 'transportation')" :checked="representative.transportation === 'car'">
                  車</label>
                <label><input type="radio" name="transportation" value="jr"
                    @click="toggleRadio($event, 'transportation')" :checked="representative.transportation === 'jr'">
                  JR</label>
                <label><input type="radio" name="transportation" value="tobu"
                    @click="toggleRadio($event, 'transportation')" :checked="representative.transportation === 'tobu'">
                  東武</label>
                <label><input type="radio" name="transportation" value="pickup"
                    @click="toggleRadio($event, 'transportation')"
                    :checked="representative.transportation === 'pickup'">
                  送迎</label>
              </td>
            </tr>
            <tr>
              <th>LINE</th>
              <td>
                <label>
                  <input type="radio" name="lineType" value="椿LINE" @click="toggleRadio($event, 'lineType')"
                    :checked="representative.lineType === '椿LINE'"> 椿LINE
                </label>
                <label>
                  <input type="radio" name="lineType" value="教室LINE" @click="toggleRadio($event, 'lineType')"
                    :checked="representative.lineType === '教室LINE'"> 教室LINE
                </label>
                <label>
                  <input type="radio" name="lineType" value="お客様LINE" @click="toggleRadio($event, 'lineType')"
                    :checked="representative.lineType === 'お客様LINE'"> お客様LINE
                </label>
              </td>
            </tr>
            <tr>
              <th>備考</th>
              <td><input type="text" class="full-width" x-model="representative.notes"></td>
            </tr>
            <tr>
              <th>リピーター</th>
              <td>
                <template x-if="representative.selectedRepeaterYears.length === 0">
                  <button type="button" class="checking-btn"
                    @click="checkRepeaterStatus()">電話番号を照合してリピーターかどうかチェックする（過去3年）</button>
                </template>
                <template x-if="representative.selectedRepeaterYears.length > 0">
                  <div>
                    <span x-show="representative.selectedRepeaterYears.includes(0)">新規</span>
                    <span x-show="!representative.selectedRepeaterYears.includes(0)"
                      x-text="representative.selectedRepeaterYears.join(', ')"></span>
                  </div>
                </template>
              </td>
            </tr>
            <tr>
              <th>お伝え事項</th>
              <td>
                <label><input type="checkbox" x-model="representative.checkpoints.rentalPage"> 浴衣レンタルページ</label>
                <label><input type="checkbox" x-model="representative.checkpoints.footwearBag"> 履物バッグ</label>
                <label><input type="checkbox" x-model="representative.checkpoints.price"> 料金</label>
                <label><input type="checkbox" x-model="representative.checkpoints.location"> 当店の場所</label>
                <label><input type="checkbox" x-model="representative.checkpoints.parking"> 駐車場</label>
              </td>
            </tr>
          </table>
        </div>
      </div>

      <div class="customer-details-grid">
        <div class="customer-column-header">
          <div class="header-item">名前</div>
          <div class="header-item">性別</div>
          <div class="header-item">体型</div>
          <div class="header-item">身長,足のサイズ</div>
          <div class="header-item">着付種別</div>
          <div class="header-item">オプション</div>
          <div class="header-item">追加レンタル</div>
          <div class="header-item">画像アップロード</div>
          <div class="header-item">合計</div>
        </div>

        <template x-for="(customer, index) in customers" :key="customer.id">
          <div class="customer-column">
            <div class="form-cell">
              <input type="text" x-model="customer.name" placeholder="">
            </div>
            <div class="form-cell">
              <label><input type="radio" :name="'gender' + index" value="female" x-model="customer.gender"> 女</label>
              <label><input type="radio" :name="'gender' + index" value="male" x-model="customer.gender"> 男</label>
            </div>
            <div class="form-cell">
              <label><input type="radio" :name="'bodyShape' + index" value="S" x-model="customer.bodyShape"> S</label>
              <label><input type="radio" :name="'bodyShape' + index" value="M" x-model="customer.bodyShape"> M</label>
              <label><input type="radio" :name="'bodyShape' + index" value="L" x-model="customer.bodyShape"> L</label>
              <input type="number" class="small-input" x-model.number="customer.weight" min="0">
              <span x-text="customer.gender === 'female' ? '号' : 'kg'"></span>
            </div>
            <div class="form-cell">
              身長 <input type="number" class="small-input" x-model.number="customer.height" min="0"> cm
              足 <input type="number" class="small-input" x-model.number="customer.footSize" min="0"> cm
            </div>
            <div class="form-cell">
              <label><input type="radio" :name="'dressingType' + index" value="rentalAndDressing"
                  x-model="customer.dressingType"> レンタル＆着付</label>
              <label><input type="radio" :name="'dressingType' + index" value="dressingOnly"
                  x-model="customer.dressingType"> 着付のみ</label>
            </div>
            <div class="form-cell">
              <div><label><input type="checkbox" x-model="customer.options.footwear"> 履き物</label></div>
              <template x-if="customer.gender === 'female'">
                <div><label><input type="checkbox" x-model="customer.options.obiBag"> かごバッグ</label></div>
              </template>
            </div>
            <div class="form-cell">
              <ul class="rental-list">
                <template x-for="(item, itemIndex) in customer.additionalRentals" :key="itemIndex">
                  <li>
                    <span x-text="`${item.name} ${item.price}円`"></span>
                    <button type="button" class="delete-btn" @click="removeRentalItem(index, itemIndex)">
                      <i class="fa-regular fa-trash-can"></i>
                    </button>
                  </li>
                </template>
              </ul>
              <button type="button" class="add-btn" @click="openRentalModal(index)">
                <i class="fa-solid fa-circle-plus"></i>
              </button>
            </div>
            <div class="form-cell">
              <input type="file" multiple @change="handleImageUpload($event, index)">
              <div class="preview-container">
                <template x-for="src in customer.imagePreviews" :key="src">
                  <img :src="src" class="preview-image">
                </template>
              </div>
            </div>
            <div class="form-cell">
              <template x-if="representative.reservationMethod">
                <span>前払：<span x-text="calculateCustomerPrepayment(customer)"></span>円 </span>
              </template>
              <span>現地：<span x-text="calculateCustomerOnSitePayment(customer)"></span>円</span>
            </div>
          </div>
        </template>
      </div>

      <div class="form-section totals-section">
        <span>グループ合計</span>
        <template x-if="representative.reservationMethod">
          <span>前払：<span x-text="prepayment"></span>円 </span>
        </template>
        <span>現地：<span x-text="onSitePayment"></span>円</span>
      </div>

      <div class="submit-container">
        <button type="submit" class="submit-btn" :disabled="isSubmitting"
          x-text="isSubmitting ? '処理中...' : (currentGroupId ? '更新' : '登録')"></button>
      </div>
      <div class="cancellation-status" x-show="currentGroupId != null">
        <label for="cancellation-toggle">
          <input type="checkbox" id="cancellation-toggle" x-model="representative.isCanceled">
          <span>キャンセルの時はここにチェックをつけて更新</span>
        </label>
      </div>
    </main>
  </form>

  <div class="modal-overlay" x-show="isRentalModalOpen" @click="isRentalModalOpen = false" x-cloak>
    <div class="modal-content" @click.stop>
      <h3>レンタル追加登録</h3>
      <div class="modal-form">
        <label>項目</label>
        <input type="text" x-model="newRentalItem.name">
      </div>
      <div class="modal-form">
        <label>価格(円)</label>
        <input type="number" x-model.number="newRentalItem.price">
      </div>
      <button class="submit-btn" @click="addRentalItem()">追加登録</button>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      AutoKana.bind('#name', '#furigana', { katakana: false });
    });
  </script>
</body>

</html>
