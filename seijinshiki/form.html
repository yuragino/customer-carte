<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>成人式登録フォーム</title>
  <!-- Custom Script -->
  <script type="module" src="../assets/js/seijinshiki/form.js"></script>
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
  <!-- Styles -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/sanitize.css">
  <link rel="stylesheet" href="../assets/css/common/layout.css">
  <link rel="stylesheet" href="../assets/css/seijinshiki/form.css">
</head>

<body x-data="app">
  <header class="header" x-show="!selectedMediaUrl">
    <div class="header-inner">
      <h1 class="header-title"><a href="../index.html">着付予約管理</a></h1>
      <div class="header-controls">
        <input type="number" min="2025" max="2060" step="1" x-model.number="selectedYear" @change="changeYear" class="text-black">
        <span>成人式</span>
      </div>
      <nav class="header-nav">
        <a :href="`./statistics.html?year=${selectedYear}`">統計情報</a>
        <a :href="`./index.html?year=${selectedYear}`">予約一覧</a>
        <a :href="`./image-list.html?year=${selectedYear}`">画像一覧</a>
        <a :href="`./form.html?year=${selectedYear}`" x-show="user" class="active">新規登録</a>
      </nav>
    </div>
  </header>
  <div class="cancellation-status" x-show="formData.isCanceled === true" x-cloak>この予約はすでにキャンセルされています</div>
  <div class="delete-container">
    <button type="button" class="delete-btn" x-show="docId" @click="deleteForm">
      <i class="fa-regular fa-trash-can"></i> カルテを削除
    </button>
  </div>
  <main>
    <form @submit.prevent="submitForm">
      <fieldset :disabled="!user" class="border-0 p-0 m-0 min-w-0">
        <div class="card">
          <h2>
            <span x-text="`${selectedYear}年成人式`" class="font-bold text-2xl text-blue-700"></span>
            <div class="title-actions" x-show="docId">
              <a :href="`print.html?year=${selectedYear}&docId=${docId}`" target="_blank" class="text-blue-500 underline underline-offset-3">印刷用ページ</a>
            </div>
          </h2>
          <table>
            <tr>
              <th>予約受付日</th>
              <td><input type="date" x-model="formData.basicInfo.reservationDate"></td>
            </tr>
            <tr>
              <th>名前</th>
              <td><input type="text" x-model="formData.basicInfo.name" required></td>
            </tr>
            <tr>
              <th>ふりがな</th>
              <td><input type="text" x-model="formData.basicInfo.kana"></td>
            </tr>
            <tr>
              <th>紹介者</th>
              <td><input type="text" x-model="formData.basicInfo.introducer"></td>
            </tr>
            <tr>
              <th>住所</th>
              <td><input type="text" x-model="formData.basicInfo.address"></td>
            </tr>
            <tr>
              <th>LINE</th>
              <td class="radio-group">
                <label>
                  <input type="radio" name="lineType" value="教室LINE" @click="toggleRadio($event, 'lineType')"
                    :checked="formData.basicInfo.lineType === '教室LINE'"> 教室LINE
                </label>
                <label>
                  <input type="radio" name="lineType" value="椿LINE" @click="toggleRadio($event, 'lineType')"
                    :checked="formData.basicInfo.lineType === '椿LINE'"> 椿LINE
                </label>
                <label>
                  <input type="radio" name="lineType" value="お客様LINE" @click="toggleRadio($event, 'lineType')"
                    :checked="formData.basicInfo.lineType === 'お客様LINE'"> お客様LINE
                </label>
              </td>
            </tr>
            <tr>
              <th>電話番号</th>
              <td><input type="tel" x-model="formData.basicInfo.phone" inputmode="numeric" pattern="[0-9]*"></td>
            </tr>
            <tr>
              <th>身長</th>
              <td><input type="number" x-model.number="formData.basicInfo.height"> cm</td>
            </tr>
            <tr>
              <th>足サイズ</th>
              <td><input type="number" x-model.number="formData.basicInfo.footSize"> cm</td>
            </tr>
            <tr>
              <th>衣装</th>
              <td>
                <button type="button" class="toggle-btn" :class="formData.basicInfo.outfit === '振袖' ? 'active-yes':'inactive'"
                  @click="formData.basicInfo.outfit = '振袖'">振袖</button>
                <button type="button" class="toggle-btn" :class="formData.basicInfo.outfit === '袴' ? 'active-yes':'inactive'"
                  @click="formData.basicInfo.outfit = '袴'">袴</button>
              </td>
            </tr>
            <tr>
              <th>利用形態</th>
              <td class="radio-group">
                <label><input type="radio" value="自前" x-model="formData.basicInfo.rentalType" @click="toggleRadio($event, 'rentalType')"
                    :checked="formData.basicInfo.rentalType === '自前'"> 自前</label>
                <label><input type="radio" value="レンタル" x-model="formData.basicInfo.rentalType" @click="toggleRadio($event, 'rentalType')"
                    :checked="formData.basicInfo.rentalType === 'レンタル'"> レンタル</label>
                <label><input type="radio" value="一部レンタル" x-model="formData.basicInfo.rentalType" @click="toggleRadio($event, 'rentalType')"
                    :checked="formData.basicInfo.rentalType === '一部レンタル'"> 一部レンタル</label>
              </td>
            </tr>
            <tr x-show="formData.basicInfo.outfit === '振袖'">
              <th>ヘアメイク担当</th>
              <td><input type="text" x-model="formData.basicInfo.hairMakeStaff"></td>
            </tr>
            <tr>
              <th>備考</th>
              <td><textarea rows="2" x-model="formData.basicInfo.outfitMemo"></textarea></td>
            </tr>
          </table>
        </div>

        <div class="card toujitsu-card">
          <h2>
            <i class="fa-regular fa-calendar-check"></i>
            <span>当日スケジュール</span>
            <button type="button" @click="swapSchedule()" class="btn title-actions" x-show="formData.basicInfo.outfit === '振袖'">
              <i class="fa-solid fa-arrows-up-down"></i>
              <span>入れ替え</span>
            </button>
          </h2>
          <table>
            <template x-for="task in formData.toujitsuInfo.schedule" :key="task.type">
              <tr x-show="!(formData.basicInfo.outfit === '袴' && task.type === 'hair')">
                <th x-text="task.type === 'hair' ? 'ヘアメイク時間' : '着付時間'"></th>
                <td>
                  <input type="time" x-model="task.start"> 〜
                  <input type="time" x-model="task.end">
                </td>
              </tr>
            </template>
            <tr>
              <th>備考</th>
              <td>
                <textarea x-model="formData.toujitsuInfo.note" rows="2"></textarea>
              </td>
            </tr>
          </table>
        </div>

        <div class="card meeting-card">
          <h2>
            <i class="fa-regular fa-calendar-days"></i>
            <span>打ち合わせ・お預かり</span>
            <button type="button" class="btn title-actions" @click="openMeetingModal()">
              <i class="fa-regular fa-plus"></i>
              <span>追加</span>
            </button>
          </h2>
          <table>
            <thead>
              <tr>
                <th>種別</th>
                <th>日時</th>
                <th>場所</th>
                <th>備考</th>
                <th></th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(meeting, index) in sortedMeetings" :key="meeting.id">
                <tr>
                  <td x-text="meeting.type"></td>
                  <td x-text="formatFullDateTime(meeting.date)"></td>
                  <td x-text="meeting.place"></td>
                  <td x-text="meeting.note"></td>
                  <td>
                    <button type="button" class="btn-edit" @click="openMeetingModal(meeting.id)">
                      <i class="fa-solid fa-pen"></i>
                    </button>
                  </td>
                  <td>
                    <button type="button" class="btn-del" @click="deleteMeeting(meeting.id)">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <div x-show="isMeetingModalOpen" class="modal-bg" @click.self="closeMeetingModal()" x-cloak>
          <div class="modal-box">
            <i class="fa-solid fa-xmark close-btn" @click="closeMeetingModal()"></i>
            <div>
              <label for="meetingType">種別</label>
              <select id="meetingType" x-model="meetingForm.type" class="meeting-select">
                <option value="着物打ち合わせ">着物打ち合わせ</option>
                <option value="ヘア打ち合わせ">ヘア打ち合わせ</option>
                <option value="お預かり">お預かり</option>
                <option value="ヘア打ち合わせ＆お預かり">ヘア打ち合わせ＆お預かり</option>
              </select>
            </div>
            <div class="mt-4">
              <label>日時</label>
              <input type="datetime-local" x-model="meetingForm.date">
            </div>
            <div class="mt-4">
              <label>場所</label>
              <input type="text" x-model="meetingForm.place">
            </div>
            <div class="mt-4">
              <label>備考</label>
              <textarea x-model="meetingForm.note"></textarea>
            </div>
            <div class="modal-actions">
              <button type="button" class="btn" @click="saveMeetingData()">保存</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>
            <i class="fa-solid fa-camera-retro"></i>
            <span>前撮り</span>
            <div class="title-actions">
              <button type="button" class="toggle-btn" :class="formData.maedoriInfo.status === 'あり' ? 'active-yes' : 'inactive'" @click="formData.maedoriInfo.status = 'あり'">
                <i class="fa-solid fa-circle-check"></i> あり
              </button>
              <button type="button" class="toggle-btn" :class="formData.maedoriInfo.status === 'なし' ? 'active-no' : 'inactive'" @click="formData.maedoriInfo.status = 'なし'">
                <i class="fa-solid fa-circle-xmark"></i> なし
              </button>
            </div>
          </h2>
          <table x-show="formData.maedoriInfo.status === 'あり'">
            <tr>
              <th>種類</th>
              <td>
                <select x-model="formData.maedoriInfo.type">
                  <option>スタジオ</option>
                  <option>ロケ</option>
                  <option>スタジオ＆ロケ</option>
                  <option>外部</option>
                </select>
              </td>
            </tr>
            <tr>
              <th>カメラマン</th>
              <td><input type="text" x-model="formData.maedoriInfo.camera"></td>
            </tr>
            <tr>
              <th>撮影日</th>
              <td><input type="date" x-model="formData.maedoriInfo.date"></td>
            </tr>
            <tr>
              <th>ヘア時間</th>
              <td><input type="time" x-model="formData.maedoriInfo.hairStart"> 〜 <input type="time" x-model="formData.maedoriInfo.hairEnd"></td>
            </tr>
            <tr>
              <th>着付時間</th>
              <td><input type="time" x-model="formData.maedoriInfo.kitsukeStart"> 〜 <input type="time" x-model="formData.maedoriInfo.kitsukeEnd"></td>
            </tr>
            <tr>
              <th>撮影時間</th>
              <td><input type="time" x-model="formData.maedoriInfo.shootStart"> 〜 <input type="time" x-model="formData.maedoriInfo.shootEnd"></td>
            </tr>
            <tr>
              <th>着付場所</th>
              <td><input type="text" x-model="formData.maedoriInfo.place"></td>
            </tr>
            <tr>
              <th>備考</th>
              <td><textarea x-model="formData.maedoriInfo.note"></textarea></td>
            </tr>
          </table>
          <table x-show="formData.maedoriInfo.status === 'なし'">
            <tr>
              <th>備考</th>
              <td><textarea x-model="formData.maedoriInfo.note"></textarea></td>
            </tr>
          </table>
        </div>

        <div class="card media-card">
          <h2><i class="fa-regular fa-images"></i> メディアアップロード</h2>
          <table>
            <tr>
              <th>画像</th>
              <td>
                <input type="file" multiple accept="image/*" @change="prepareMediaPreview($event, 'image')">
                <div class="preview-container">
                  <template x-for="(url, index) in formData.media.imageUrls" :key="url">
                    <div class="flex gap-1 border border-gray-400 p-1">
                      <img :src="url" class="preview-image" @click="openMediaModal('image',url)">
                      <button type="button" class="btn-del" @click="removeMedia('saved-image', index)">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </div>
                  </template>
                  <template x-for="(src, index) in formData.media.newImagePreviews" :key="src">
                    <div class="flex gap-1 border border-gray-400 p-1">
                      <img :src="src" class="preview-image" @click="openMediaModal('image',url)">
                      <button type="button" class="btn-del" @click="removeMedia('new-image', index)">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </div>
                  </template>
                </div>
              </td>
            </tr>
            <tr>
              <th>動画</th>
              <td>
                <input type="file" multiple accept="video/*" @change="prepareMediaPreview($event, 'video')">
                <div class="preview-container">
                  <template x-for="(url, index) in formData.media.videoUrls" :key="url">
                    <div class="flex gap-1 border border-gray-400 p-1">
                      <video :src="url" class="preview-image" @click="openMediaModal('video',url)"></video>
                      <button type="button" class="btn-del" @click="removeMedia('saved-video', index)">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </div>
                  </template>
                  <template x-for="(src, index) in formData.media.newVideoPreviews" :key="src">
                    <div class="flex gap-1 border border-gray-400 p-1">
                      <video :src="src" class="preview-image" @click="openMediaModal('video',url)"></video>
                      <button type="button" class="btn-del" @click="removeMedia('new-video', index)">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </div>
                  </template>
                </div>
              </td>
            </tr>
            <tr>
              <th>YouTubeリンク</th>
              <td>
                <input type="text" placeholder="https://www.youtube.com/watch?v=XXXXXX" x-model="formData.media.youtubeLink" class="w-full border rounded p-1">
              </td>
            </tr>
          </table>
        </div>

        <div class="card estimate-card" x-show="!formData.estimateInfo.isMiyuki">
          <h2>
            <i class="fa-solid fa-yen-sign"></i> 見積もり
            <button type="button" class="btn title-actions" @click="addOption()">
              <i class="fa-regular fa-plus"></i>
              <span>オプション追加</span>
            </button>
          </h2>
          <table>
            <tr>
              <th>項目</th>
              <th>当日</th>
              <th>前撮り</th>
              <th>金額</th>
              <th></th>
            </tr>

            <tr>
              <td>着付</td>
              <td class="clickable-cell">
                <label class="toggle-check">
                  <input type="checkbox" x-model.boolean="formData.estimateInfo.kitsuke.hasToujitsu">
                  <i class="fa-regular fa-circle-xmark"></i>
                  <i class="fa-regular fa-circle-check"></i>
                </label>
              </td>
              <td class="clickable-cell">
                <label class="toggle-check">
                  <input type="checkbox" x-model.boolean="formData.estimateInfo.kitsuke.hasMaedori">
                  <i class="fa-regular fa-circle-xmark"></i>
                  <i class="fa-regular fa-circle-check"></i>
                </label>
              </td>
              <td><input type="number" x-model.number="formData.estimateInfo.kitsuke.price" class="!w-20 text-right">円</td>
              <td></td>
            </tr>

            <tr x-show="formData.basicInfo.outfit === '振袖'">
              <td>
                <select x-model="formData.estimateInfo.hairMake.type">
                  <option value="ヘア＆メイク">ヘア＆メイク</option>
                  <option value="ヘアのみ">ヘアのみ</option>
                  <option value="ヘアメイクなし">ヘアメイクなし</option>
                </select>
              </td>
              <td class="clickable-cell">
                <template x-if="formData.estimateInfo.hairMake.type === 'ヘアメイクなし'">
                  <span class="disabled-label">対象外</span>
                </template>
                <template x-if="formData.estimateInfo.hairMake.type !== 'ヘアメイクなし'">
                  <label class="toggle-check">
                    <input type="checkbox" x-model.boolean="formData.estimateInfo.hairMake.hasToujitsu">
                    <i class="fa-regular fa-circle-xmark"></i>
                    <i class="fa-regular fa-circle-check"></i>
                  </label>
                </template>
              </td>
              <td class="clickable-cell">
                <template x-if="formData.estimateInfo.hairMake.type === 'ヘアメイクなし'">
                  <span class="disabled-label">対象外</span>
                </template>
                <template x-if="formData.estimateInfo.hairMake.type !== 'ヘアメイクなし'">
                  <label class="toggle-check">
                    <input type="checkbox" x-model.boolean="formData.estimateInfo.hairMake.hasMaedori">
                    <i class="fa-regular fa-circle-xmark"></i>
                    <i class="fa-regular fa-circle-check"></i>
                  </label>
                </template>
              </td>
              <td><input type="number" x-model.number="formData.estimateInfo.hairMake.price" class="!w-20 text-right">円</td>
              <td></td>
            </tr>

            <template x-for="(item,index) in formData.estimateInfo.options" :key="index">
              <tr>
                <td><input type="text" x-model="item.name"></td>
                <td class="clickable-cell">
                  <label class="toggle-check">
                    <input type="checkbox" x-model="item.hasToujitsu">
                    <i class="fa-regular fa-circle-xmark"></i>
                    <i class="fa-regular fa-circle-check"></i>
                  </label>
                </td>
                <td class="clickable-cell">
                  <label class="toggle-check">
                    <input type="checkbox" x-model="item.hasMaedori">
                    <i class="fa-regular fa-circle-xmark"></i>
                    <i class="fa-regular fa-circle-check"></i>
                  </label>
                </td>
                <td><input type="number" x-model.number="item.price" class="!w-20 text-right">円</td>
                <td>
                  <button type="button" class="btn-del" @click="deleteOption(index)">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </td>
              </tr>
            </template>

            <tr>
              <td colspan="3" class="text-center">合計</td>
              <td class="total" x-text="formatYen(totalAmount)"></td>
              <td></td>
            </tr>
          </table>
        </div>

        <div class="card receipt-card">
          <h2 class="flex justify-between">
            <span><i class="fa-solid fa-receipt"></i> 領収情報</span>
            <label><input type="checkbox" x-model.boolean="formData.estimateInfo.isMiyuki"> 美ゆきさん扱い</label>
          </h2>
          <table>
            <tr>
              <th>領収日</th>
              <td><input type="date" x-model="formData.estimateInfo.receiptDate"></td>
            </tr>
          </table>
        </div>

        <div class="actions">
          <button type="submit" class="btn register-btn" :disabled="isSubmitting"
            x-text="isSubmitting ? '処理中...' : (docId ? '更新' : '登録')"></button>
        </div>

        <div class="cancellation-status" x-show="docId">
          <label for="cancellation-toggle">
            <input type="checkbox" id="cancellation-toggle" x-model="formData.isCanceled">
            <span>キャンセルの時はここにチェックをつけて更新</span>
          </label>
        </div>
      </fieldset :disabled="!user" class="border-0 p-0 m-0 min-w-0">
    </form>

    <div x-show="selectedMediaUrl" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50" @click.self="closeMediaModal">
      <img x-show="selectedMediaType === 'image'" :src="selectedMediaUrl" class="max-w-[90%] max-h-[90%] rounded-lg shadow-lg object-contain" />
      <video x-show="selectedMediaType === 'video'" :src="selectedMediaUrl" controls autoplay class="max-w-[90%] max-h-[90%] rounded-lg shadow-lg object-contain"></video>
    </div>
  </main>
</body>

</html>
